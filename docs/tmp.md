# Data Ingestion Issue Prioritization & Roadmap (Based on 50-Chunk Sample Analysis)

## ä¼˜å…ˆçº§ P0 (ä¸¥é‡å½±å“æ£€ç´¢è´¨é‡ä¸Žè¯­ä¹‰)

### 1. å™ªå£°æ±¡æŸ“ (Watermark & Header/Footer)
*   **çŽ°è±¡**: æ¯ä¸ª Chunk éƒ½åŒ…å« "ruyi"ã€"Downloaded by..."ã€"JEDEC Standard No. 84-B51" ç­‰é‡å¤å¹²æ‰°ä¿¡æ¯ã€‚
*   **å½±å“**: æ±¡æŸ“ Embedding å‘é‡ç©ºé—´ï¼Œé™ä½Žç›¸å…³åº¦åˆ†å€¼ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: åœ¨ `parser.py` å®žçŽ° BBox åæ ‡è¿‡æ»¤ï¼ˆå‰”é™¤é¡µçœ‰é¡µè„šåŒºåŸŸï¼‰å¹¶å¢žåŠ æ­£åˆ™å…¨å±€æ¸…æ´—ã€‚

### 2. æ®‹æ¡©ç¢Žç‰‡ (Stub Chunks)
*   **çŽ°è±¡**: å‡ºçŽ°å¤§é‡ä»…åŒ…å« "cont'd"ã€"continued on next page" æˆ–ç‰©ç†åˆ†é¡µç¬¦çš„ç¢Žç‰‡ï¼ˆChunk 7, 10, 14, 19ï¼‰ã€‚
*   **å½±å“**: æµªè´¹æ£€ç´¢çª—å£ï¼ˆContext Windowï¼‰ï¼Œå¯¼è‡´ LLM å¬å›žæ— æ•ˆä¿¡æ¯ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: å®žæ–½ `_is_valid_chunk` é€»è¾‘ï¼ˆåˆ†ç±»åž‹æœ€å°é˜ˆå€¼è¿‡æ»¤ï¼‰å¹¶å¢žå¼º `Semantic Flow Merger`ï¼ˆè·¨é¡µåˆå¹¶ï¼‰ã€‚

### 3. æŠ€æœ¯å‚æ•°è¡¨è¯¯åˆ¤ (Table Detection & Misclassification)
*   **çŽ°è±¡**: å…³é”®ç”µå¹³/æµ‹è¯•è¡¨ï¼ˆå¦‚ Chunk 1ï¼‰è¢«è¯¯åˆ¤ä¸ºæ­£æ–‡å¯¼è‡´ä¹±ç ï¼Œéƒ¨åˆ†è¡¨è¢«è¯¯åˆ¤ä¸º `figure`ã€‚
*   **å½±å“**: æ ¸å¿ƒæŠ€æœ¯å‚æ•°é‡‡é›†ä¸¢å¤±ï¼Œæ— æ³•å‡†ç¡®å›žç­”å…·ä½“ bit ä½æˆ–ç”µåŽ‹å€¼ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: è°ƒä¼˜ `pdfplumber` å‚æ•°ï¼ˆ`snap_tolerance`ï¼‰ï¼Œå¹¶æ”¯æŒ `vertical_strategy: text` ä½œä¸ºå›žé€€ç­–ç•¥ã€‚

---

## ä¼˜å…ˆçº§ P1 (å½±å“ä¸Šä¸‹æ–‡å‡†ç¡®æ€§ä¸Žæœç´¢å‘½ä¸­)

### 4. ç« èŠ‚è·¯å¾„æ¼‚ç§» (Section Path Drift)
*   **çŽ°è±¡**: Chunk å†…å®¹ä¸Žå…¶ Metadata ä¸­çš„ `section_title` æˆ– `section_path` ä¸åŒ¹é…ï¼ˆå¦‚ Chunk 30ï¼‰ã€‚
*   **å½±å“**: æä¾›é”™è¯¯çš„ä¸Šä¸‹æ–‡å‚è€ƒï¼Œå¯èƒ½å¯¼è‡´ LLM åœ¨å¯»æ‰¾â€œç¬¬ X ç« â€æ—¶äº§ç”Ÿå¹»è§‰ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: åœ¨ `parser.py` çš„è§£æžå¾ªçŽ¯ä¸­å¯¹æ ‡é¢˜æ£€æµ‹é€»è¾‘å¢žåŠ å¼ºä¸€è‡´æ€§æ ¡éªŒï¼ˆBarrier Checkï¼‰ã€‚

### 5. å¯„å­˜å™¨ä½åŸŸç ´ç¢Ž (Register Map Fragmentation)
*   **çŽ°è±¡**: å¯„å­˜å™¨æè¿°ï¼ˆå¦‚ [187] ä½åŸŸï¼‰è¢«åˆ‡åˆ†åˆ°ä¸åŒå—ä¸­ï¼Œç¼ºä¹æ•´ä½“è§†å›¾ä¿¡æ¯ã€‚
*   **å½±å“**: æ— æ³•å›žç­”å¤æ‚çš„å¯„å­˜å™¨ç»“æž„é—®é¢˜ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: é’ˆå¯¹ `ContentType.REGISTER` å®žæ–½ç‰¹æ®Šçš„åˆå¹¶ç­–ç•¥ï¼Œç¡®ä¿ä¸€ä¸ªå®Œæ•´çš„ä½åŸŸæ˜ å°„åŒºå—ä¸è¢«åˆ†å‰²ã€‚

### 6. Unicode/ç‰¹æ®Šå­—ç¬¦ä¸ä¸€è‡´
*   **çŽ°è±¡**: é¢‘ç¹å‡ºçŽ° `e â€¢MMC`ã€`âˆ† TPH`ã€`e 2 â€¢MMC` ç­‰éžæ ‡å­—ç¬¦ã€‚
*   **å½±å“**: å…³é”®è¯æ£€ç´¢ï¼ˆKeyword Matchï¼‰å‘½ä¸­çŽ‡ä½Žã€‚
*   **è§£å†³æ–¹æ¡ˆ**: åœ¨æ¸…æ´—é˜¶æ®µå®žæ–½æ ‡å‡†æ–‡æœ¬å½’ä¸€åŒ–ï¼ˆNormalizeï¼‰ï¼Œç»Ÿä¸€æ›¿æ¢ä¸º `eMMC` ç­‰æ ¸å¿ƒè¯ã€‚

---

## ä¼˜å…ˆçº§ P2 (å±€éƒ¨ä¼˜åŒ–)

### 7. è¡¨æ ¼å•å…ƒæ ¼å•å…ƒå™ªå£°
*   **çŽ°è±¡**: å¤æ‚çŸ©é˜µè¡¨ä¸­æ··å…¥ `i/y/u` ç­‰çº¿æ¡æ®‹ç•™å­—ç¬¦ã€‚
*   **å½±å“**: å±€éƒ¨æŽ’ç‰ˆç•¥ä¹±ï¼Œè¯­ä¹‰å½±å“ç›¸å¯¹è¾ƒå°ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: åœ¨è¡¨æ ¼æå–è¿‡ç¨‹ä¸­å¢žåŠ å•å­—ç¬¦å•å…ƒæ ¼è¿‡æ»¤é€»è¾‘ã€‚

---

## Code Review å‘çŽ°é—®é¢˜ï¼ˆåŸºäºŽ Gemini ä¿®æ”¹ç‰ˆæœ¬çš„é™æ€åˆ†æž + è¿è¡ŒéªŒè¯ï¼‰

### Bug 8. `stats()` front_matter æ•°å€¼ä¸¥é‡å¤±çœŸï¼ˆpipeline.py:134â€“136ï¼‰ðŸ”´

*   **çŽ°è±¡**: è¿è¡Œè¾“å‡º `front_matter: 391`ï¼Œè€Œå®žé™… `is_front_matter=True` çš„ chunk åªæœ‰ **76** æ¡ï¼Œè™šæŠ¥äº† 315 æ¡ã€‚
*   **æ ¹å› **: `front_matter_count = total - searchable - short_filtered` è¿™ä¸ªæŽ¨å¯¼å…¬å¼æ²¡æœ‰è€ƒè™‘"full-table chunksï¼ˆ`is_row_chunk=False`ï¼‰è¢« `searchable_chunks` æŽ’é™¤ä½†æ—¢ä¸æ˜¯ front matter ä¹Ÿä¸æ˜¯ short_filtered"çš„æƒ…å†µï¼Œå¯¼è‡´è¿™ 315 æ¡è¢«é”™è¯¯å½’å…¥ front matterã€‚
*   **è§£å†³æ–¹æ¡ˆ**: ä¸è¦ç”¨æŽ¨å¯¼ï¼Œç›´æŽ¥ç»Ÿè®¡ï¼š
    ```python
    front_matter_count = sum(1 for c in self.chunks if c.is_front_matter)
    ```

---

### Bug 9. `_is_valid_chunk()` è§£æž `chunk.text` åŽ» prefix çš„æ–¹å¼ä¸å¯é ï¼ˆpipeline.py:51â€“68ï¼‰ðŸ”´

*   **çŽ°è±¡**: å‡½æ•°é€šè¿‡è·³è¿‡ `chunk.text` çš„ç¬¬ä¸€è¡Œæ¥åŽ»æŽ‰ prefixï¼Œä½† TABLE chunk çš„ `text` ç¬¬äºŒè¡Œæ˜¯ caption è¡Œï¼ˆå¦‚ `Table 49 â€” Basic commands`ï¼‰ï¼Œä¸æ˜¯çº¯å†…å®¹ï¼›TEXT chunk ä¸­ä¿¡å·åï¼ˆ"DAT1"ã€"DAT2"ï¼Œ4å­—ç¬¦ï¼‰è¢« `min_chars=40` è¿‡æ»¤æŽ‰ï¼Œä¸¢å¤±æœ‰æ•ˆæŠ€æœ¯å†…å®¹ã€‚ç»éªŒè¯ï¼Œ82 ä¸ª text chunk è¢«è¯¯è¿‡æ»¤ã€‚
*   **æ ¹å› **: `raw_text` å­—æ®µå­˜æ”¾çš„å°±æ˜¯åŽ»æŽ‰ prefix çš„å†…å®¹ï¼Œæ˜¯æ­£ç¡®çš„æ£€éªŒå¯¹è±¡ï¼›å½“å‰å´è§£æž `text` å­—ç¬¦ä¸²ã€ä¾èµ– prefix æ ¼å¼å‡è®¾ï¼Œè„†å¼±ä¸”ä¸å‡†ç¡®ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: æ”¹ç”¨ `raw_text` åšé•¿åº¦åˆ¤æ–­ï¼š
    ```python
    def _is_valid_chunk(chunk: EMMCChunk) -> bool:
        content = chunk.raw_text.strip()
        min_chars = _MIN_RAW_CHARS_BY_TYPE.get(chunk.content_type, 30)
        if len(content) < min_chars:
            ...
    ```

---

### Bug 10. å•å­—ç¬¦å™ªå£°è¿‡æ»¤è¯¯åˆ  Y/N åˆ—æ•°æ®ï¼ˆparser.py:470â€“471ï¼‰ðŸ”´

*   **çŽ°è±¡**: `if len(c) == 1 and c.lower() in 'iyun'` ä¼šæŠŠè¡¨æ ¼å•å…ƒæ ¼ä¸­å•ç‹¬çš„ `'y'`ã€`'n'`ã€`'u'` æ›¿æ¢ä¸º `None`ã€‚
*   **æ ¹å› **: `'Y'`/`'N'` æ˜¯ eMMC spec capability è¡¨æ ¼ä¸­çš„æ ‡å‡†å€¼ï¼ˆè¡¨ç¤º Supported/Not Supportedï¼‰ï¼›`'U'` è¡¨ç¤º Undefinedï¼›`'R'`/`'W'` ç­‰å…¶ä»–å•å­—ç¬¦åŒæ ·æœ‰æ„ä¹‰ã€‚å½“å‰é€»è¾‘ä¸ŽæŽ’ç‰ˆçº¿æ¡æ®‹ç•™ï¼ˆé€šå¸¸æ˜¯ `'i'`ï¼‰æ··ä¸ºä¸€è°ˆï¼Œè¿‡åº¦è¿‡æ»¤ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: åªè¿‡æ»¤å·²çŸ¥çš„æŽ’ç‰ˆçº¿æ¡æ®‹ç•™å­—ç¬¦ï¼Œä¿ç•™è¯­ä¹‰å­—ç¬¦ï¼š
    ```python
    # 'i' æ˜¯ pdfplumber è¯¯è¯»è¡¨æ ¼ç«–çº¿çš„å…¸åž‹æ®‹ç•™ï¼Œ'u' ç›¸å¯¹å®‰å…¨ï¼›
    # 'y'/'n' å¿…é¡»ä¿ç•™ï¼Œå®ƒä»¬æ˜¯åˆæ³•çš„èƒ½åŠ›æ ‡å¿—å€¼ã€‚
    if len(c) == 1 and c.lower() in 'i':
        clean_row.append(None)
    ```
    æ›´ç¨³å¥çš„åšæ³•æ˜¯ç»“åˆ `font_size` æˆ– `bbox` é«˜åº¦æ¥åˆ¤æ–­æ˜¯å¦ä¸ºçº¿æ¡è¯¯è¯†åˆ«ï¼Œè€Œéžä¾èµ–å­—ç¬¦å€¼ã€‚

---

### Bug 11. Definition æ–‡æœ¬æ”¶é›†ä½¿ç”¨å°šæœªæ›´æ–°çš„ `current_section`ï¼ˆpipeline.py:244â€“251ï¼‰ðŸŸ¡

*   **çŽ°è±¡**: å½“ä¸€é¡µå†…å­˜åœ¨ sub-page section åˆ‡æ¢æ—¶ï¼Œè¯¥é¡µæ–° section çš„æ–‡æœ¬ä¼šè¢«é”™è¯¯åœ°å½’å…¥ä¸Šä¸€ä¸ª section çš„å®šä¹‰æ¡¶ï¼Œå¯¼è‡´ Round 1 å®šä¹‰æå–çš„ç« èŠ‚å½’å±žé”™è¯¯ã€‚
*   **æ ¹å› **: ç¬¬ä¸€ä¸ª `for cb in classified` å¾ªçŽ¯ï¼ˆæ”¶é›†å®šä¹‰æ–‡æœ¬ï¼‰åœ¨ç¬¬äºŒä¸ªå¾ªçŽ¯ï¼ˆæ‰§è¡Œ sub-page æ£€æµ‹ã€æ›´æ–° `current_section`ï¼‰ä¹‹å‰æ‰§è¡Œï¼Œæ‰€ä»¥æ”¶é›†æ—¶ `current_section` ä»æ˜¯ä¸Šé¡µæœ«å°¾çš„å€¼ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: å°†ä¸¤ä¸ªå¾ªçŽ¯åˆå¹¶ä¸ºä¸€ä¸ªï¼Œåœ¨å¤„ç†æ¯ä¸ª block æ—¶å…ˆåš section æ£€æµ‹å†æ”¶é›†æ–‡æœ¬ï¼Œä¿è¯æ”¶é›†æ—¶çš„ `current_section` å·²æ˜¯æœ€æ–°å€¼ã€‚

---

### è®¾è®¡é—®é¢˜ 12. `_normalize_heading()` ä¸Ž `_normalize_label()` ä¸¤ä»½é‡å¤å®žçŽ°ï¼ˆpipeline.py:78â€“84 vs structure.py:86â€“92ï¼‰ðŸŸ¡

*   **çŽ°è±¡**: ä¸¤ä¸ªå‡½æ•°å®žçŽ°å®Œå…¨ç›¸åŒï¼ˆ`strip().lower()` â†’ `re.sub ç©ºç™½` â†’ `strip(". ")`ï¼‰ï¼Œä½†åˆ†åˆ«ç‹¬ç«‹å®šä¹‰åœ¨ä¸¤ä¸ªæ¨¡å—ä¸­ã€‚`label_to_section` çš„ key ç”¨ `_normalize_label()` ç”Ÿæˆï¼Œpipeline çš„ lookup ç”¨ `_normalize_heading()`ï¼Œå½“å‰æ°å¥½ä¸€è‡´ï¼Œä¸€æ—¦æœ‰äººä¿®æ”¹å…¶ä¸­ä¸€ä¸ªå°†é™é»˜å¤±æ•ˆã€‚
*   **è§£å†³æ–¹æ¡ˆ**: å°† `_normalize_label()` ä»Ž `structure.py` exportï¼Œåœ¨ `pipeline.py` ç›´æŽ¥å¯¼å…¥å¤ç”¨ï¼Œåˆ é™¤ `_normalize_heading()`ã€‚

---

### è®¾è®¡é—®é¢˜ 13. `label_to_section` é‡å¤ key é™é»˜è¦†ç›–ï¼ˆstructure.py:131â€“133ï¼‰ðŸŸ¡

*   **çŽ°è±¡**: eMMC spec ä¸­å¤šä¸ªç« èŠ‚å¯èƒ½æ‹¥æœ‰ç›¸åŒçš„çŸ­æ ‡é¢˜ï¼ˆå¦‚å¤šå¤„å‡ºçŽ° "General"ã€"Timing"ï¼‰ï¼Œå­—å…¸æŽ¨å¯¼å¼åŽè€…ä¼šé™é»˜è¦†ç›–å‰è€…ï¼Œsub-page section æ£€æµ‹æ—¶ä¼šè·³è½¬åˆ°é”™è¯¯çš„ sectionã€‚
*   **è§£å†³æ–¹æ¡ˆ**: åªä¿ç•™ç¬¬ä¸€æ¬¡å‡ºçŽ°çš„å”¯ä¸€ labelï¼Œè·³è¿‡åŽç»­é‡å¤ï¼š
    ```python
    label_map: dict[str, SectionNode] = {}
    for s in sections:
        key = _normalize_label(s.label)
        if key not in label_map:
            label_map[key] = s
    ```

---

### ç»´æŠ¤é—®é¢˜ 14. å¼‚å¸¸é™é»˜åžæ²¡ï¼ˆparser.py:479â€“480ï¼‰ðŸŸ¢

*   **çŽ°è±¡**: `except Exception: pass` è®© pdfplumber åœ¨æŸé¡µè§£æžå¤±è´¥æ—¶ä¸ç•™ä»»ä½•è®°å½•ï¼Œè¡¨æ ¼é™é»˜ä¸¢å¤±ï¼Œéš¾ä»¥æŽ’æŸ¥ã€‚
*   **è§£å†³æ–¹æ¡ˆ**:
    ```python
    except Exception as exc:
        logger.warning("pdfplumber failed on page %d: %s", idx + 1, exc)
    ```

---

### ç»´æŠ¤é—®é¢˜ 15. `jEDEC` æ‹¼å†™é”™è¯¯ï¼ˆpipeline.py:41ï¼‰ðŸŸ¢

*   **çŽ°è±¡**: `_NOISE_PATTERNS` ä¸­å†™ä½œ `jEDEC Standard`ï¼Œåº”ä¸º `JEDEC Standard`ã€‚å› ä¸ºè®¾ç½®äº† `re.IGNORECASE` æ‰€ä»¥åŠŸèƒ½ä¸å—å½±å“ï¼Œä½†æ‹¼å†™æ··ä¹±ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: æ”¹ä¸º `JEDEC`ã€‚

---

### ç»´æŠ¤é—®é¢˜ 16. `PageModel` æœªä½¿ç”¨çš„ importï¼ˆpipeline.py:15ï¼‰ðŸŸ¢

*   **çŽ°è±¡**: `from .parser import PDFParser, PageModel` ä¸­ `PageModel` åœ¨æ¨¡å—å†…æœªè¢«ç›´æŽ¥å¼•ç”¨ã€‚
*   **è§£å†³æ–¹æ¡ˆ**: ç§»é™¤ `PageModel`ã€‚

---
## ä»Ž chunks.jsonl è§‚å¯Ÿåˆ°çš„é—®é¢˜
